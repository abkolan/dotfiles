name: Smoke Test

on:
  push:
    branches: [ test-actions, smoke-test ]
  workflow_dispatch:

env:
  FORCE_COLOR: 1

jobs:
  smoke-test:
    name: Smoke Test - Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate repository structure
        run: |
          echo "ðŸ” Validating dotfiles repository structure..."
          
          # Essential directories
          required_dirs=("zsh" "nvim" "git" "tests")
          for dir in "${required_dirs[@]}"; do
            if [[ -d "$dir" ]]; then
              echo "âœ… $dir/"
            else
              echo "âŒ Missing: $dir/"
              exit 1
            fi
          done
          
          # Essential files
          required_files=("README.md" "setup.sh" ".gitignore")
          for file in "${required_files[@]}"; do
            if [[ -f "$file" ]]; then
              echo "âœ… $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done
      
      - name: Validate test infrastructure
        run: |
          echo "ðŸ§ª Validating test infrastructure..."
          
          # Check test scripts exist and are executable
          test_scripts=("tests/test-all.sh" "tests/test-fast.sh" "tests/run-tests.sh")
          for script in "${test_scripts[@]}"; do
            if [[ -f "$script" ]]; then
              echo "âœ… Found: $script"
              chmod +x "$script"
              
              # Syntax check
              if bash -n "$script"; then
                echo "âœ… Syntax valid: $script"
              else
                echo "âŒ Syntax error: $script"
                exit 1
              fi
            else
              echo "âŒ Missing: $script"
              exit 1
            fi
          done
      
      - name: Validate Docker files
        run: |
          echo "ðŸ³ Validating Docker test infrastructure..."
          
          docker_files=("tests/Dockerfile.base" "tests/Dockerfile.fast")
          for dockerfile in "${docker_files[@]}"; do
            if [[ -f "$dockerfile" ]]; then
              echo "âœ… Found: $dockerfile"
              
              # Basic Dockerfile syntax check
              if grep -q "^FROM" "$dockerfile"; then
                echo "âœ… Valid Dockerfile: $dockerfile"
              else
                echo "âŒ Invalid Dockerfile: $dockerfile"
                exit 1
              fi
            else
              echo "âŒ Missing: $dockerfile"
              exit 1
            fi
          done
      
      - name: Quick security scan
        run: |
          echo "ðŸ”’ Quick security scan..."
          
          # Check for obvious security issues
          if grep -r "password\|token\|secret" --include="*.sh" --include="*.zsh" . | grep -v "^[[:space:]]*#"; then
            echo "âš ï¸ Potential secrets found in files"
            exit 1
          else
            echo "âœ… No obvious secrets found"
          fi
          
          # Check for hardcoded paths
          if grep -r "/Users/[^/]*" --include="*.sh" --include="*.zsh" .; then
            echo "âš ï¸ Hardcoded user paths found"
            exit 1
          else
            echo "âœ… No hardcoded paths found"
          fi
      
      - name: Validate configuration files
        run: |
          echo "âš™ï¸ Validating configuration files..."
          
          # Check ZSH configs
          if [[ -f "zsh/.zshrc" ]]; then
            echo "âœ… ZSH config found"
            if zsh -n "zsh/.zshrc" 2>/dev/null; then
              echo "âœ… ZSH config syntax valid"
            else
              echo "âŒ ZSH config syntax error"
              exit 1
            fi
          fi
          
          # Check if essential tools are configured
          essential_configs=("git/.gitconfig" "nvim/.config/nvim/init.lua")
          for config in "${essential_configs[@]}"; do
            if [[ -f "$config" ]]; then
              echo "âœ… Found: $config"
            else
              echo "âš ï¸ Optional config missing: $config"
            fi
          done
      
      - name: Test README instructions
        run: |
          echo "ðŸ“– Validating README instructions..."
          
          # Check if README has basic sections
          if grep -q "Quick Start\|Installation\|Usage" "README.md"; then
            echo "âœ… README has installation instructions"
          else
            echo "âŒ README missing installation instructions"
            exit 1
          fi
          
          # Check if test instructions are present
          if grep -q "test" "README.md"; then
            echo "âœ… README mentions testing"
          else
            echo "âš ï¸ README should mention how to run tests"
          fi
      
      - name: Generate smoke test summary
        if: always()
        run: |
          echo "# ðŸ’¨ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Validated Components" >> $GITHUB_STEP_SUMMARY
          echo "- Repository structure (directories & files)" >> $GITHUB_STEP_SUMMARY
          echo "- Test infrastructure (test-all.sh, test-fast.sh)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker test setup (Dockerfiles)" >> $GITHUB_STEP_SUMMARY
          echo "- Security (no secrets or hardcoded paths)" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration files (syntax validation)" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation (README completeness)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "This smoke test validates basic repository health." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**For functional testing:**" >> $GITHUB_STEP_SUMMARY
          echo "- Quick: \`./tests/test-fast.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "- Complete: \`./tests/test-all.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**For development:**" >> $GITHUB_STEP_SUMMARY
          echo "- Component tests: \`./tests/run-tests.sh <component>\`" >> $GITHUB_STEP_SUMMARY
          echo "- See [test documentation](./tests/README.md) for details" >> $GITHUB_STEP_SUMMARY