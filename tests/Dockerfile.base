# Base image with all dependencies pre-installed
# Build this once: docker build -t dotfiles-base -f tests/Dockerfile.base .
ARG BASE_IMAGE=ubuntu:22.04
FROM ${BASE_IMAGE}

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install all dependencies at once
RUN apt-get update && apt-get install -y \
    git curl wget sudo zsh neovim \
    build-essential stow \
    fd-find ripgrep fzf bat jq \
    locales python3 python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Generate locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create test user
RUN useradd -m -s /bin/zsh testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create fd symlink
RUN ln -sf /usr/bin/fdfind /usr/local/bin/fd || true

# Install additional tools that aren't in apt
USER testuser
WORKDIR /home/testuser

# Pre-install eza
RUN curl -sL https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz | \
    tar xz -C /home/testuser/.local/bin 2>/dev/null || true

# Pre-clone Zinit to speed up installation
RUN mkdir -p /home/testuser/.local/share/zinit && \
    git clone https://github.com/zdharma-continuum/zinit.git \
    /home/testuser/.local/share/zinit/zinit.git --quiet

USER testuser
WORKDIR /home/testuser

# This base image is ready for dotfiles testing